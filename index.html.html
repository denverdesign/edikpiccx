<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini Photoshop Web</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      background-color: #2c2c2c;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      background-color: #1e3a5f;
      width: 100%;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between; /* Este es el cambio clave en el CSS */
      align-items: center;
    }

    .btn-header {
      background-color: #294d7b;
      border: none;
      padding: 10px 15px;
      color: white;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.3s ease;
      text-align: center;
      font-size: 14px;
    }

    .btn-header:hover {
      background-color: #3a6fa6;
    }
    
    /* Contenedor para los botones de la derecha */
    .header-actions {
        display: flex;
        gap: 10px; /* Espacio entre los botones */
    }

    canvas {
      margin-top: 20px;
      background-color: #ffffff;
      border: 2px solid #444;
      max-width: 100%;
      height: auto;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    select,
    .btn-effect {
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background-color: #294d7b;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    select:hover,
    .btn-effect:hover {
      background-color: #3a6fa6;
    }

    footer {
      margin-top: auto;
      padding: 10px;
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>

  <header>
    <!-- Este div vacío a la izquierda empuja todo lo demás a la derecha -->
    <div></div> 

    <!-- Este div agrupa los botones a la derecha -->
    <div class="header-actions">
      <button class="btn-header" onclick="downloadImage()">Descargar</button>
      <label class="btn-header">
        Subir Imagen
        <input type="file" accept="image/*" onchange="uploadImage(event)" style="display:none;">
      </label>
    </div>
  </header>

  <canvas id="canvas" width="600" height="400"></canvas>

 <div class="controls">
    <select id="filterSelect" onchange="applyFilter(this.value)">
      <option value="">-- Selecciona un filtro --</option>
      <option value="grayscale">Blanco y Negro</option>
      <option value="sepia">Sepia</option>
      <option value="brightness">Brillo</option>
      <option value="invert">Invertir Colores</option>
      <option value="saturate">Saturación</option>
      <option value="none">Ninguno</option>
    </select>

    <!-- ESTA ES LA LÍNEA CORRECTA -->
    <a href="/download/agent" class="btn-effect" style="text-decoration: none;">Efecto (Magicos)</a>

</div>

  <footer>
    Mini App Photoshop - By ChatGPT
  </footer>

<script>
    // --- Lógica del Canvas y Filtros (Sin cambios) ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let originalImage = null;

    function uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function applyFilter(filter) {
        if (!originalImage) return;

        // Reset to original image before applying a new filter
        ctx.putImageData(originalImage, 0, 0); 
        if (filter === "none") return;

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            switch (filter) {
                case 'grayscale': const gray = (r + g + b) / 3; data[i] = data[i + 1] = data[i + 2] = gray; break;
                case 'sepia': data[i] = Math.min(255, 0.393 * r + 0.769 * g + 0.189 * b); data[i + 1] = Math.min(255, 0.349 * r + 0.686 * g + 0.168 * b); data[i + 2] = Math.min(255, 0.272 * r + 0.534 * g + 0.131 * b); break;
                case 'brightness': data[i] = Math.min(255, r * 1.5); data[i + 1] = Math.min(255, g * 1.5); data[i + 2] = Math.min(255, b * 1.5); break;
                case 'invert': data[i] = 255 - r; data[i + 1] = 255 - g; data[i + 2] = 255 - b; break;
                case 'saturate': const avg = (r + g + b) / 3; data[i] = avg + 50; data[i + 1] = avg + 20; data[i + 2] = avg - 20; break;
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'imagen_editada.png';
        link.href = canvas.toDataURL();
        link.click();
    }


    // ==========================================================
    // ===          NUEVA FUNCIÓN PARA EL BOTÓN "EFECTO"        ===
    // ==========================================================

    async function enviarOrdenDeDescarga() {
      // 1. Preguntar al usuario por la URL del archivo de Mega
      const urlMega = prompt("Por favor, introduce la URL completa del archivo de Mega que quieres descargar en el teléfono:");

      // 2. Si el usuario introduce una URL y no cancela
      if (urlMega && urlMega.trim() !== "") {
        console.log(`Enviando orden de descarga para la URL: ${urlMega}`);
        
        try {
          // La URL del servidor ahora apunta a la ruta relativa '/trigger-download'
          // ya que esta página será servida por nuestro servidor Python.
          const respuesta = await fetch('/trigger-download', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            // Enviamos un objeto JSON con la URL
            body: JSON.stringify({ url: urlMega }),
          });

          if (respuesta.ok) {
            alert('¡Orden de descarga enviada con éxito!\nEl teléfono recibirá una notificación.');
          } else {
            // Si el servidor responde con un error (404, 500, etc.)
            const errorTexto = await respuesta.text();
            throw new Error(`El servidor respondió con un error: ${respuesta.status} - ${errorTexto}`);
          }

        } catch (error) {
          console.error('Error al enviar la orden:', error);
          alert(`Hubo un error al comunicar con el servidor.\nDetalle: ${error.message}`);
        }

      } else {
        // Si el usuario cancela o no introduce nada
        alert('Operación cancelada.');
      }
    }

</script>
</body>
</html>